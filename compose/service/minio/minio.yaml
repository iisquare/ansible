- hosts: minio
  user: root
  vars:
    service_dir: "{{ fs_work_dir }}/service/minio"
  tasks:
  - name: make service dir
    tags: ['never', 'init']
    file:
      path: "{{ service_dir }}"
      state: directory

  - name: copy Dockerfile
    tags: ['never', 'init']
    copy:
      src: ./Dockerfile
      dest: "{{ service_dir }}/Dockerfile"

  - name: change compose
    tags: ['never', 'init']
    blockinfile:
      backup: no
      marker: '# {mark} SERVICE FOR MINIO'
      path: "{{ fs_work_dir }}/docker-compose.yml"
      block: |
        # Do not modify manually
          minio:
            build:
              context: ./service/minio
              args:
                - MINIO_VERSION=${MINIO_VERSION}
            environment:
              MINIO_ROOT_USER: ${MINIO_ROOT_USER}
              MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
            ports:
              - "${BIND_ADDRESS}${BIND_COLON}${MINIO_HTTP_PORT}:9000"
              - "${BIND_ADDRESS}${BIND_COLON}${MINIO_CONSOLE_PORT}:9001"
            command: server {{ fs_server_url }} --console-address ":9001"
            volumes:
              - ${DATA_DIR}/minio/export1:/export1
              - ${DATA_DIR}/minio/export2:/export2
